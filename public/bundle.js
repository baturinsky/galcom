!function(){"use strict";let t,e=e=>(t=(69069*t+1)%Math.pow(2,31))%e,s=()=>e(1e9)/1e9;function i(e=null){return null!=e&&(t=e),t}function n(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))}function a(t,e){return n(r(t,e))}function r(t,e){return[e[0]-t[0],e[1]-t[1]]}function o(t,e){return[e[0]+t[0],e[1]+t[1]]}function l(t,e=1){const s=e/(n(t)||1);return[t[0]*s,t[1]*s]}function h(t,e,s){let i=[t],n=[];n[t]=0;let a=[],r=null;for(let t=0;t<1e4&&0!=i.length;t++){let t=i.shift();if(t==e){for(r=[];t>=0;)r.push(t),t=a[t];r.reverse();break}for(let[e,r]of s(t)){let s=r+n[t];if(!(e in n)||n[e]>s){let r=i.findIndex(t=>n[t]>s);i.splice(r>=0?r:i.length,0,e),n[e]=s,a[e]=t}}}return{route:r,distances:n,prev:a}}function d(t){return t.reduce((t,e)=>t+e,0)}function c(t){let e=s()*d(t)-t[0];if(0==e)return t[0];let i=0;for(;e>=0;)e-=t[++i];return i}function p(t,e=1,s=1){let i=d(t),n=1+(e-i)*s/i;return i?t.map(t=>t*n):t}const u=100,g=.03;const f="=CRAFTS=\nindustry\nmining\nconstruction\nenergetics\nspace\nfood\ntechnology\nmedicine\nscience\nstocks\ngalcom\ntravel\n=ARTS=\nsport\nart\nmusic\nponies\nfunny\nkittens\nmovies\ngames\nadult\nliterature\nphoto\nhistory\n=ISSUES=\nnews\npolitics\nemigration\ncensorship\nunemployment\npollution\nninjas\nillness\npoverty\nepidemy\nrevolution\nwar".split("\n"),m=f.filter(t=>/^[a-z]/.test(t)),k={};for(let t=0;t<m.length;t++)k[m[t]]=t;let $=f.indexOf("=ARTS=")-1,b=f.indexOf("=ISSUES=")-2;const v=m.map((t,e)=>e<$?3-.1*e:e<b?1:.2*-(e-b)),y=m.map((t,e)=>e<$?1-.03*e:e<b?.1:.1*-(e-b)),w=m.map((t,e)=>e<b?1:e<b+6?0:.5),x=m.length;function M(t){return 240-t/x*270}function L(t,e=100){return`hsla(${M(t)},100%,80%, ${e}%)`}console.log(m.slice(0,$)),console.log(m.slice($,b)),console.log(m.slice(b)),console.log(y),console.log(v),console.log(w);let S={};for(let t=0;t<x;t++)S[t]=L(t);class T{constructor(){this.talks=[],this.talkers=[],this.has=[],this.makes=[],this.links={},this.linksLengths=[],this.income=0,this.logs=[],this.pricing=0,this.grit=1}serialise(){let t=Object.assign({},this);return delete t.logs,delete t.links,delete t.linksLengths,t}static order(t,e){return t.id<e.id?[t,e]:[e,t]}static linkId(t,e){return[t,e]=T.order(t,e),t.id*u+e.id}generateMakes(t){this.makes[t]=Math.pow(e(100)-50,3)/1e5,t>=b&&(this.makes[t]=Math.abs(this.makes[t]))}generate(){this.name=function(){let t="";for(let s=e(3)+2;s--;)t+="x.lexegezacebisousesarmaindirea.eratenberalavetiedorquanteisrion".substr(2*e(33),2);return t=(t=t.replace(/\./g,""))[0].toUpperCase()+t.substr(1)}(),this.at=[e(830)+10,e(850)+10],this.pop=0,this.capacity=e(100)/10+1;for(let t=0;t<x;t++)this.generateMakes(t),this.has[t]=this.makes[t]*(.5+s()),this.talks[t]=Math.pow(e(100),3);return this.talkers=[...new Array(100)].map(t=>0),this.balanceTalks(),this.updateColor(),this}shakeTalks(){for(let t=0;t<x;t++)this.talks[t]+=Math.pow(e(5),4)/(e(300)?1e7:3e3);this.balanceTalks()}balanceTalks(){this.talks=p(this.talks)}activity(){return this.pop}averageTag(){return d(this.talks.map((t,e)=>t*e))/(d(this.talks)+.01)}maxTag(){return this.talks.reduce(([t,e],s,i)=>s>e?[i,s]:[t,e],[0,0])}linkTo(t){return this.links[t.id]}registerLink(t,e){this.links[t.id]=e,this.linksLengths.push([t.id,e.length])}removeLink(t){delete this.links[t.id],this.linksLengths.splice(this.linksLengths.findIndex(e=>e[0]==t.id),1)}log(t){this.logs.push(t),this.logs.length>300&&this.logs.splice(0,100)}growCapped(t){this.changePop(t/(1+Math.pow(this.pop/this.capacity,2)))}changePop(t){this.pop+=t,this.pop<0&&(this.pop=0)}updateColor(){this.color=M(this.maxTag()[0])}interact(t,e,s){console.assert(s<36);let i=Math.abs(e),n=t.has[s]-this.has[s];(n=Math.pow(Math.abs(n),.5)*Math.sign(n))<0&&s>=$&&s<b&&(n*=.2);let a=s>b?-.1*(s-b):1,r=n*i*a*g,o=(r*=Math.min(r>0?this.pop:t.pop,1))/(this.pop+.01);r>0?this.has[k.emigration]+=o:this.has[k.unemployment]-=o;let l=Math.pow(t.pop/(this.pop+.1),.5),h=(n+.05*a)*(i*=l)*.3;this.has[s]+=h,s>=b&&(this.grit+=.01*i),this.log({that:t,migration:r,flow:e,tag:s,delta:n,sizeAdjust:l,dhas:h,makes:this.makes[s],has:this.has[s]}),this.changePop(-r)}update(t){let i=c(this.has.map(t=>Math.abs(t)));console.assert(i<36);let n=(this.makes[i]-this.has[i])*t*2;if(this.has[i]+=n,i!=k.epidemy&&i!=k.illness||(this.has[i]-=this.has[k.medicine]*t*5,this.talks[k.medicine]+=Math.abs(this.has[i]*t*.02)),this.talks[i]+=.1*s()*t,this.balanceTalks(),s()<.1*t&&this.generateMakes(e(x)),this.pop>this.capacity&&s()<t){let t=[k.unemployment,k.pollution,k.poverty][e(3)];this.has[t]+=(this.pop-this.capacity)/10,this.has[[k.politics,k.news][e(2)]]+=s()*this.grit/10}let a=.02*t*this.has[i]*(this.has[i]<0?y[i]:v[i]);a<0&&(this.grit+=t*a*10,a/=1+.5*this.grit,this.has[x-1-e(6)]+=a*s()),this.grit*=1-.01*t*this.pop,this.grit<0&&(this.grit=0),a*=.1+this.pop,this.log({tag:i,growth:a,pop:this.pop,has:this.has[i],talks:this.talks[i],dt:t}),this.growCapped(a)}}class R{constructor(t){this.ends=t,this.width=1,this.flow=0,this.talks=Array.from({length:x},()=>.01),this.talkers=Array.from({length:100},()=>0),this.length=a(this.ends[0].at,this.ends[1].at)}distToPoint(t){let[e,s]=[this.ends[0].at,this.ends[1].at];return a(e,t)+a(s,t)-a(e,s)}serialise(){let t=Object.assign({},this);return t.ends=this.ends.map(t=>t.id),t}update(t){this.flow/=1+t,this.talks=p(this.talks),this.talkers=p(this.talkers)}get id(){return 1e3*this.ends[0].id+this.ends[1].id}center(){return[(this.ends[0].at[0]+this.ends[1].at[0])/2,(this.ends[0].at[1]+this.ends[0].at[1])/2]}}const P=50,B=400,I=.5,A=[["*Entanglements",3,200,100,t=>`You need one entanglements to install a link or expand it. You have ${t.entsLeft} entanglements left of ${t.rd[C]} total. It will cost $${t.linkPrice()} (and an entanglement) to install a new link or expansion. Reclaiming entanglements is free`],["Link range",2,1e3,1e3,t=>`Maximum link range is ${t.linkRange()} pc.`],["R&D Speed",0,1e3,200,t=>`R&D speed is ${100*t.rdSpeed()|0}%. You get 50% for each repeat of this research, and also 1% for each 200EB sent.`],["Latency",0,1e4,1e4,t=>`Connection speed is increased by ${100*t.speedBoost()}%, and by same amount for the each extra expansion`],["Broadband",0,1e4,1e4,t=>`Each link can transfer ${t.baseBandwith()}TB/s. Each link expansion increases it by ${t.bandwithUpgrade()}TB/s. \n    Going over this limit increases latency by 1ms/s per each TB/s.`],["Flexible pricing",0,1e4,5e3,t=>`Ability to discount or overcharge your service in specific system.\n  Discounting reduces profit per message by half, but increases number of messages by ${100*t.pricingBonus()}%.\n  Overcharging reduces messages by half, but increases profit per message by ${100*t.pricingBonus()}%.\n  You can discount/overcharge ${t.rd[D]} systems.`],["Search Engine",0,1e4,1e4,t=>`You can promote up to ${t.rd[F]} topics. \n  That reduces profit per message by half for that topic, but increases messages by ${100*t.promotingBonus()}%`],["Investments",0,1e5,1e5,t=>`You can invest into any topic up to ${t.rd[Y]} times, permanently increasing profit from related messages by 25%.`],["Targeted Adverts",0,5e4,5e4,t=>"You have created an algorithm that will learn from messages you transport and improve profits.\n  After sending certain amount of messages of any topic you will start getting 25% more income from such messages. \n  Also, if you get such bonus for all topics, you will be able to unlock next level of this upgrade. \n  After doing it 5 times, something interesting may happen.\n  "],["Social Engineering",0,3e4,1e4,t=>`You have enough knowledge and leverage to \n  make people through galaxy very interested in a topic of your choice. You will need to repeat this research for each such action.\n  You can do it up to ${t.rd[H]} times`]],C=0,E=1,U=2,O=3,j=4,D=5,F=6,Y=7,N=8,H=9;const q=300,z=0,W=1,X=2;let G=z,J=!1;function K(t){return`${t}`.replace(/[0-9]+(\.[0-9]*)?/g,t=>`<em>${(+t).toLocaleString("en-US",{maximumFractionDigits:0})}</em>`)}!function(t){for(let e=0;e<3e4&&t.colonized<3;e++)t.update(1/60);class s{update(s){if($)return!0;if(this.route.length>0){let i=t.stars[this.route[0]].at,n=s*q;if(a(i,this.at)<n)this.at=i,this.route.shift(),this.update(e(1e3)/1e4);else{let t=l(r(this.at,i),n);this.at=o(this.at,t)}}return this.route.length>0}render(t){t.fillStyle=S[this.tag];let e=Math.pow(this.weight,.5);t.fillRect(this.at[0]-e,this.at[1]-e+1,2*e,2*e)}}class n{constructor(t,e,s=1){this.text=t,this.at=e,this.dieIn=s,this.t=0}update(t){return this.t+=t,this.at[1]-=30*t,this.t<this.dieIn}render(t){t.fillStyle=`hsla(0,100%,100%,${100*(1-this.t/this.dieIn)}%)`,t.fillText(this.text,this.at[0],this.at[1])}}function h(t,e,s,i){return`<span id=${t} class="ref" style="${s?`color:${s}`:""};${i?`font-size:${0|i}`:""}">${e}</span> `}let d,c,p,u=[],g=null,f=null,k=null,$=!1,b=-1,v=-1;function y(){f=g=k=null,c=d=p=null,b=-1}let w={at:[0,0],pressed:!1},x=document.getElementById("C"),M=document.getElementById("D"),P=x.getContext("2d"),B=M.getContext("2d");x.width=x.height=900,M.width=M.height=900,P.font=B.font="14px Lucida Console, Monaco, monospace";let C=document.getElementById("panel"),E=document.getElementById("menu"),U=0,O=0,j=P.getImageData(0,0,900,900);for(let t=0;t<5e4;t++)j.data.set([e(155)+100,e(155)+100,e(155)+100,e(70)],4*e(81e4));let V=[];function Q(){for(let e of t.stars)V[e.id]=[e.at[0]-8.5,e.at[1]-9.5,20+(0|P.measureText(e.name).width),18]}function Z(){return g||d||f||c}function _(){E.innerHTML=["R&D","Overview","Saves"].map((t,e)=>`<button id="seePage:${e}" style="${e!=G||Z()?"":"border-bottom:solid 1px black"}"">${t}</button>`).reverse().join("")}function tt(t){G=t,_(),ct()}function et(t,e){return[0,1].every(s=>t[s]>e[s]&&t[s]<e[s]+e[s+2])}function st(t,e,s=1,i="#fff",n=B){n.strokeStyle=i,n.beginPath(),n.lineWidth=s,n.moveTo(t[0],t[1]),n.lineTo(e[0],e[1]),n.stroke(),n.lineWidth=1}function it(e,s,i=!1){let[n,a]=e.ends.map(t=>t.at);st(n,a,2*e.width,"#666",s);let r=t.overflow(e);st(n,a,2*e.width+4,`hsla(0,${100*Math.pow(r,.25)}%,70%,${(i?60*(Math.sin(10*U)+1):0)+(r?40:0)}%)`,s)}function nt(t,e){u.push(new n(t,e?e.slice():[450,450],.5+t.length/20))}function at(){if(t.entsLeft<=0)nt("No Entanglements left (increase in R&D)",null==c?void 0:c.center());else{if(!(t.cash<t.linkPrice()))return!0;nt(`Need $${t.linkPrice()}`,null==c?void 0:c.center())}return!1}Q(),kt(),_(),window.seePage=tt,M.onmousedown=(e=>(w.pressed=!0,b=-1,g?(f==g?f=null:(f=g,kt(),e.shiftKey&&(console.log(f),console.log(t))),d=c=null):d?(e.shiftKey&&console.log(c),c=c==d?null:d,f=g=null):f=c=null,$&&mt(),_(),!1)),M.onmouseup=(e=>{w.pressed=!1,f&&g&&f!=g&&((c=f.links[g.id])||(t.inRange(f,g)?at()&&(t.payForLink(),t.addLink(f,g),nt(`-*1 -$${t.linkPrice()}`,f.at),kt()):nt("out of range",f.at)),f=null),kt()});let rt=M.getBoundingClientRect();function ot(e){let n=t.serialise();n.packets=u.filter(t=>t instanceof s),n.seed=i();let a=JSON.stringify(n);a=a.replace(/([0-9]+\.[0-9]+)/g,t=>(+t).toPrecision(6)),localStorage[`galcom${e}`]=a,localStorage[`galcomname${e}`]=`${(new Date).toISOString().substr(0,19).replace("T"," ")}<br/>${t.date().toFixed(1)} AD $${0|t.cash} *${t.entsLeft}`,nt("SAVED",[450,450]),ct()}function lt(e){u=[];let n=localStorage[`galcom${e}`],a=JSON.parse(n);a.seed&&(i(a.seed),delete a.seed);let r=a.packets;if(r)for(let t of r){let e=new s;Object.assign(e,t),u.push(e)}t.deserialise(a),$=!1,nt("LOADED",[450,450]),Q(),kt()}M.onmousemove=(e=>{w.at=[e.clientX-rt.left,e.clientY-rt.top];let s=g;g=null,v=-1;for(let e of t.stars)if(et(w.at,V[e.id])){g=e,d=null,ct();break}if(g&&!s&&ct(),!g){let e=function(t,e){let[s,i]=[-1e99,null];for(let n of t)e(n)>s&&(s=e(n),i=n);return i}(t.links,t=>-t.distToPoint(w.at));e&&e.distToPoint(w.at)<.5?(d=e,ct()):null!=d&&(d=null,ct())}$&&mt(),s&&!g&&(ct(),_())}),onkeydown=(e=>{switch(e.key){case" ":$=!$,mt();break;case"s":ot(0);break;case"l":lt(0);break;case"@":J=!J,ct();break;case"!":t.cash+=1e6,t.rd=t.rd.map((e,s)=>e+t.rdActive[s]),t.rdActive.fill(0),t.rdProgress.fill(0)}});let ht=document.getElementById("header");function dt(){ht.innerHTML=`<em>${t.date().toFixed(2)}</em>AD `+K(`Pop:${t.pop.toFixed(1)}BL <span id="rdh:0">Entanglements:*${t.entsLeft}</span> Sent:${0|t.exp}EB Money:$${0|t.cash}`)}function ct(){let e=Z(),s="";if(b>=0&&!g&&!d)s="<h3>Tag</h3>";else if(e instanceof T)s=`<button class="close">X</button> <h3><big style="color:${ut(n=e)}">${n.name}</big> ${n.pop>0?`<em>${n.pop.toPrecision(3)}</em>BL $${K(n.income+n.pop*I)}/s`:"Uninhabited"}</h3>`+(0==n.pricing&&0==t.pricingLeft?"":`<p><button ${-1==n.pricing?'class="enabled"':""} style="color:#8f8" id="pricing:${n.id}:-1">Discount</button><button ${1==n.pricing?'class="enabled"':""} style="color:#f88" id="pricing:${n.id}:1">Overcharge</button></p>`)+(J?function(t){return'<div class="stardbg">'+m.map((e,s)=>[e,t.makes[s],t.has[s]].map((t,e)=>`<div id="tag:${s}" style="color:${e?`hsl(${60*t+60},80%, 80%)`:L(s)}">${e?t.toFixed(2):t}</div>`).join("")).join("")+`</div>Grit: ${t.grit.toFixed(1)} Capacity: ${0|t.capacity}`}(n):`${0==Object.keys(n.links).length?"":"<h4>Linked</h4> "+Object.entries(n.links).map(([e,s])=>h("link:"+s.id,t.stars[e].name,ut(t.stars[e]))).join("")}\n      ${0==n.pop?"":`<h4>Top topics</h4>\n      ${pt(n.talks,30)}\n      <h4>Friends</h4>\n      ${gt(n.talkers,20)}\n      `}`);else if(e instanceof R)s=`<button class="close">X</button><h3>${(i=e).ends.map(t=>h("star:"+t.id,`<big>${t.name}</big>`,ut(t))).join(`&lt;${"=".repeat(i.width)}&gt; `)} </h3>\n    <p>${K(`${0|i.flow}/${t.linkBandwith(i)}TB/s ${0|t.latencyOf(i)}ms`)}</p>\n    <p><button id="linkup:-1">${1==i.width?"Remove":"Downgrade"}</button><button id="linkup:1">Expand</button></p>\n    <h4>Top topics</h4>\n    ${pt(i.talks,30)}\n    <h4>Used by</h4>\n    ${gt(i.talkers,20)}\n    `;else switch(G){case z:s=function(){let e=[];for(let s=0;s<t.rd.length;s++){let i=100*t.rdProgress[s],n=`background: linear-gradient(90deg, #aaa ${i}%, #${t.rdActive[s]?"444":"000"} ${i+.1}%)`,a=t.researchImpossible(s);e.push(`${a?`<div id="rd:${s}" style="text-align:center">${a}</div>`:`<button style="${n}" id="rd:${s}">${(t.rdActive[s]>1?`x${t.rdActive[s]} `:"")+A[s][0]}</button>`}<button style="visibility:${t.rdActive[s]?"":"hidden"}" class="rdx" id="rdx:${s}">||</button><div>&nbsp;${t.rd[s]}</div><div>$${0|t.rdRemainingCost(s)}</div>`)}return t.hasTagControls()&&e.push('<div class="tagsControls">'+m.map((e,s)=>[e,"P","I","E",""].map((e,i)=>{let n=1,a=i>0&&i<4;return a&&(n=t.options([F,Y,H][i-1],s)),0==i?`<div id="tag:${s}" style="cursor:pointer;color:${L(s)}">#${m[s]}</div>`:2==i&&t.invested[s]&&(e=`<em>${t.invested[s]}</em>`,0==n)?`<div style="text-align: center;">${e}</div>`:3==i&&t.rd[N]&&t.encouraged[s]?`<div style="text-align: center;"><em>${(t.encouraged[s]/10).toFixed(1)}</em></div>`:4==i&&t.rd[N]?`<div>${100*(1+t.tagsResearched[s]-t.rd[N])|0}%</div>`:0==n?"<div></div>":`<div class="${a?"tagControl":""}" id="tagControl:${s}:${i}" style="background:${2==n?"#888":"#000"}">${e}</div>`}).join("")).join("")+"</div>"),`<div id="rdmenu">${e.join("")}</div>`}();break;case W:s+=K(`<p>${t.date().toFixed(1)} AD</p>Money: $${0|t.cash}<br/>Entanglements: *${t.entsLeft}<br/>Overcharge/discounts: ${t.pricingUsed}/${t.rd[D]} <br/>Pop: ${0|t.pop} BL<br/>Income: $${t.income+t.passiveIncome()|0}/s<br/>Sent: ${0|t.exp}EB<br/>Flow: ${0|t.flow}TB/s`)+`<h4>Top topics</h4>${pt(t.talks)} <h4>Top systems</h4>${gt(t.stars.map(e=>5*e.pop/t.pop),40)}`;break;case X:for(let t=0;0==t||localStorage[`galcom${t-1}`];t++){let e=localStorage[`galcomname${t}`];s+=`<button ${e?"":"disabled"} id="load:${t}">${e||"New Save"}</button><button id="save:${t}">Save</button>`}s=`<div id="saves">${s}</div>`}var i,n;C.innerHTML=s}function pt(t,e=100){return ft(t).slice(0,e).map(([t,e])=>h("tag:"+t,"#"+m[t],S[t],Math.min(50,10+200*e))).join(" ")}function ut(t){return`hsl(${t.color},100%,80%)`}function gt(e,s=100){return ft(e).slice(0,s).map(([e,s])=>s?h("star:"+e,t.stars[e].name,ut(t.stars[e]),10+Math.min(10,100*s)):"").join("")}function ft(t){return Object.entries(t).sort((t,e)=>e[1]-t[1])}function mt(){B.clearRect(0,0,900,900);let e=document.getElementById("paused").classList;$?e.remove("off"):e.add("off");for(let t of[g,k].filter(t=>t))B.strokeStyle=`hsl(${t.color},100%,80%)`,B.strokeRect.apply(B,V[t.id]);if(v>=0){B.save();for(let e of t.stars)0!=e.pop&&(B.beginPath(),B.strokeStyle=L(v),B.lineWidth=.5+Math.pow(e.pop,.5)/3,B.arc(e.at[0],e.at[1],100*e.talks[v],0,2*Math.PI),B.stroke());B.restore()}if(f&&(B.strokeStyle=`hsl(${f.color},100%,40%)`,B.strokeRect.apply(B,V[f.id]),w.pressed&&g!=f)){let e=Math.min(t.linkRange(),a(f.at,w.at));st(f.at,o(f.at,l(r(f.at,w.at),e)),1,"#fff",B),B.fillStyle="#888",B.fillText((0|a(f.at,w.at)).toString(),w.at[0]+10,w.at[1]);for(let e of t.stars)e!=f&&e!=g&&a(f.at,e.at)<=t.linkRange()&&(B.strokeStyle=`hsla(${e.color},100%,40%,40%)`,B.strokeRect.apply(B,V[e.id]))}B.save(),[d,c,p].forEach(t=>t&&it(t,B,!0)),B.restore(),B.save();for(let t of u)t.render(B);B.restore();for(let e=0;e<t.rdProgress.length;e++)0!=t.rdProgress[e]&&(B.fillStyle=t.rdActive[e]?"#ddd":"#777",B.beginPath(),B.moveTo(10,28+25*e),B.arc(10,28+25*e,7,.5*Math.PI,Math.PI*(.5+2*t.rdProgress[e])),B.closePath(),B.fill());B.strokeStyle="#fff"}function kt(){let e;P.putImageData(j,0,0),P.lineWidth=1,f&&(e=t.findDistances(f).distances);for(let s of t.stars){P.fillStyle=`hsl(${["150,80%","0,0%","0,80%"][s.pricing+1]}, ${0==s.pop?15:Object.keys(s.links).length?70:40}%)`;let t=s.name+(e&&e[s.id]?"\n"+(0|e[s.id])+"ms":"");P.fillText(t,s.at[0]+8,s.at[1]+5),P.save();let i=Math.pow(s.pop,.5)/2+1;P.fillStyle=`hsla(${s.color},100%,70%,30%)`,P.fillRect(s.at[0]-1.25,s.at[1]-2*i-.5,1.5,4*i),P.fillRect(s.at[0]-2*i-.5,s.at[1]-1.25,4*i,1.5);for(let t=1.5;t>.4;t-=.2)P.fillStyle=`hsla(${s.color},100%,${150-80*t}%,${100-60*t}%)`,P.beginPath(),P.arc(s.at[0]-.5,s.at[1]-.5,i*t*1.1,0,2*Math.PI),P.fill()}P.save(),t.links.forEach(t=>it(t,P)),P.restore()}function $t(i,n,a,r){let o=new s;o.route=r,o.tag=n,o.at=t.stars[i].at.slice(),o.weight=a,u.push(o),o.update(e(1e3)/1e4)}function bt(t){let e=t.target.id;return e?e.split(":"):[]}document.onmousedown=(e=>{let s=e.target,i=bt(e),[n,a]=[Number(i[1]),Number(i[2])];if(s.classList.contains("close"))return c=f=null,ct(),void _();switch(i[0]){case"helpToggle":case"helpToggleHeader":let e=document.getElementById("help"),s="block"==e.style.display;e.style.display=s?"none":"block";break;case"seePage":y(),tt(n);break;case"save":return ot(n);case"load":return lt(n);case"paused":return $=!$,void mt();case"rdh":t.rdActive[0]++,$=!1;break;case"rd":t.rdActive[n]++,$=!1;break;case"rdx":t.rdActive[n]=0;break;case"linkup":if(1==n&&!at())break;t.upgradeLink(c,n),0==c.width&&(c=null),kt();break;case"link":y();let r=t.linkById(n);c=r;break;case"star":y(),f=t.stars[n];break;case"pricing":t.togglePricing(t.stars[n],a),kt();break;case"tagControl":t.tagControl([F,Y,H][a-1],n),xt()}$&&mt(),dt(),ct()});let vt=document.getElementById("tooltip");document.onmouseout=(t=>{switch(bt(t)[0]){case"tag":v=-1}}),document.onmousemove=(e=>{let s=e.target,i=bt(e),[n,a]=[Number(i[1]),Number(i[2])];switch(i[0]){case"tag":n!=v&&(v=n,mt());break;case"rdh":xt(s,0);break;case"rd":t.exp>=t.researchExpRequired(n)&&xt(s,n);break;case"pricing":break;case"tagControl":xt(s,n+100,a);break;case"link":p=t.linkById(n),k=null;break;case"star":k=t.stars[n],p=null,$&&mt();break;default:vt.style.opacity="0",k=null,p=null,v=-1}});let yt=0,wt=0;function xt(e,s,i){if(i>=0&&(wt=i),s>=0&&(yt=s),e){let t=Math.max(50,e.offsetTop);vt.style.cssText=`top:${t}px; opacity:1`}if(yt>=0&&yt<100)vt.innerHTML=K(A[yt][4](t));else if(yt>=100){let e=yt-100;switch(wt){case 1:vt.innerHTML=t.promoted[e]?`Stop promoting ${Mt(e)}.`:`Promote ${Mt(e)}.`;break;case 2:vt.innerHTML=`Invest $${K(t.investCost(e))} into ${Mt(e)}.`;break;case 3:vt.innerHTML=`Encourage interest in ${Mt(e)}`;break;default:vt.innerHTML=Mt(e)}}}function Mt(t){return`<span style="color:${L(t)}">#${m[t]}</span>`}!function e(s){U=s/1e3;let i=Math.min(.1,U-O);if(u=u.filter(t=>t.update(i)),!$&&!document.hidden){t.update(i)&&kt();for(let e=0;e<t.packets.length&&e<3;e++){let s=t.packets[e];$t(s[0],s[2],s[3],s[4])}dt(),mt(),G!=z&&(0|U)==(0|O)||(ct(),xt())}O=U,window.requestAnimationFrame(e)}(0)}(new class{constructor(){this.stars=[],this.links=[],this.packets=[],this.time=0,this.colonized=1,this.cash=1e3,this.entsUsed=0,this.pricingUsed=0,this.promotionsUsed=0,this.encouragementsUsed=0,this.latency=[],this.talks=[],this.rd=A.map(t=>t[1]),this.rdActive=A.map(t=>0),this.rdProgress=A.map(t=>0),this.invites=[],this.promoted=[],this.invested=[],this.encouraged=[],this.tagsResearched=[],this.exp=0,this.flow=0,this.pop=0,this.income=0,i(1);for(let t=200;t--&&this.stars.length<u;){let t=(new T).generate();this.stars.every(e=>t.name!=e.name&&(Math.abs(t.at[0]-e.at[0])>50||Math.abs(t.at[1]-e.at[1])>20))&&(t.id=this.stars.length,this.stars.push(t))}for(let t=0;t<x;t++)this.promoted[t]=!1,this.invested[t]=this.tagsResearched[t]=this.encouraged[t]=0;this.stars[0].pop=10}get entsLeft(){return this.rd[C]-this.entsUsed}pricingBonus(){return 1+.25*this.rd[D]}get pricingLeft(){return this.rd[D]-this.pricingUsed}promotingBonus(){return.5+.5*this.rd[F]}overflow(t){return Math.max(0,t.flow-this.linkBandwith(t))}baseBandwith(){return 50+25*this.rd[j]}bandwithUpgrade(){return 50+50*this.rd[j]}speedBoost(){return.1*this.rd[O]}rdSpeed(){return 1+.5*this.rd[U]+this.exp/2e4}date(){return 2100+this.time/10}rdRemainingCost(t){return(1-this.rdProgress[t])*this.rdFullCost(t)}rdFullCost(t){return A[t][2]+A[t][3]*this.rd[t]}linkRange(){return 50+25*this.rd[E]}inRange(t,e){return a(t.at,e.at)<=this.linkRange()}latencyOf(t){let e=this.latency[t.ends[0].id].find(e=>e[0]==t.ends[1].id);return e?e[1]:1e3}recalculateLatency(){this.latency=this.stars.map(t=>Object.entries(t.links).map(([t,e])=>[Number(t),(e.length+10+this.overflow(e))/(1+this.speedBoost()*e.width)]))}addLink(t,e,s=1){let i=new R(T.order(t,e));return i.width=s,t.registerLink(e,i),e.registerLink(t,i),this.links.push(i),i}serialise(){let t=Object.assign({},this);return t.stars=this.stars.map(t=>t.serialise()),t.links=this.links.map(t=>t.serialise()),delete t.packets,t}deserialise(t){Object.assign(this,t),this.rd.length<A.length&&(this.rd=A.map((t,e)=>this.rd[e]||0),this.rdActive=A.map((t,e)=>this.rdActive[e]||0),this.rdProgress=A.map((t,e)=>this.rdProgress[e]||0)),this.stars=[],this.links=[];for(let e of t.stars)this.deserialiseStar(e);for(let e of t.links)this.deserialiseLink(e);console.log(this)}deserialiseLink(t){let e=this.addLink(this.stars[t.ends[0]],this.stars[t.ends[1]]);delete t.ends,Object.assign(e,t)}deserialiseStar(t){let e=new T;return Object.assign(e,t),e.balanceTalks(),this.stars.push(e),e}talk(t,e,s){let{route:i,distances:n}=this.findPath(t,e),a=1e3,r=1;if(i){let o=3/(1+(a=n[e.id])/100);this.promoted[s]&&(o/=2,r*=1+this.promotingBonus()),this.rd[N]&&(o*=1+.25*(0|this.tagsResearched[s])),this.invested[s]&&(o*=1+.25*this.invested[s]),1==e.pricing?(o*=1+this.pricingBonus(),r/=2):-1==e.pricing&&(o/=2,r*=1+this.pricingBonus()),e.income+=o*r,this.cash+=o*r,this.exp+=r,this.packets.push([t.id,e.id,s,r,i]);for(let n=0;n<i.length-1;n++){let[a,o]=[this.stars[i[n]],this.stars[i[n+1]]],l=a.links[o.id];l.flow+=r,l.talks[s]+=1e-4*r,l.talkers[t.id]+=1e-4*r,l.talkers[e.id]+=1e-4*r}}this.rd[N]>0&&this.tagsResearched[s]<this.rd[N]&&(this.tagsResearched[s]+=1/B/Math.pow(2,this.rd[N]-1)*r,this.tagsResearched[s]>this.rd[N]&&(this.tagsResearched[s]=this.rd[N]));let o=.001*(1500-a)*r;t.talkers[e.id]+=1e-4*o,e.talkers[t.id]+=1e-4*o,t.interact(e,o,s),e.interact(t,-o,s)}passiveIncome(){return this.pop*I}update(t){let i=(0|this.time)!=(this.time+t|0);this.time+=t,this.cash+=t*this.passiveIncome(),this.flow=this.pop=0,this.income=this.passiveIncome();let n=this.stars.map(t=>t.activity());this.packets.length=0;for(let e=0;e<x;e++)this.encouraged[e]>0&&(this.encouraged[e]=Math.max(0,this.encouraged[e]-t));for(let e of this.links)e.update(t),this.flow+=e.flow;this.recalculateLatency();for(let e=d(n)*t*3;e>0;e--){let t=this.stars[c(n)],e=c(t.talks),s=this.invites[e];null!=s&&s!=t.id?(this.talk(this.stars[s],t,e),this.invites[e]=null):this.invites[e]=t.id}for(let e of this.stars)this.updateStar(e,t),this.pop+=e.pop,this.income+=e.income;this.talks.fill(0,0,x);for(let t of this.stars)for(let e=x;e--;)this.talks[e]+=t.talks[e]*t.activity();this.talks=p(this.talks);for(let e=0;e<this.rdActive.length;e++)this.rdActive[e]>0&&this.doRD(e,t)&&this.rdActive[e]--;let a=e(x);if(s()<t*Math.pow(this.talks[a],2)*100){console.log("censoring tag "+m[a]);for(let t of this.stars)t.has[a]*=s(),t.talks[a]*=s()}if(s()<1e-4*t*this.pop){let[t,s,i]=[this.stars[e(u)],x-e(6)-1,Math.pow(e(50),2)];console.log(`Unleashing ${i} of ${m[s]} on ${t.name}`),t.has[s]=i}return i}updateStar(t,i){t.income/=1+i;let n=x-e(6)-1;if(Math.abs(t.has[n])>3){let e=this.stars[c(this.stars.map(e=>e!=t?1/(a(t.at,e.at)+.1):0))],r=(t.has[n]-e.has[n])*s()*i;e.has[n]+=r,t.has[n]-=r}if(t.pop>0&&s()<10*i){t.update(i),t.talkers=p(t.talkers);let s=this.stars[e(u)],n=Math.min(.1,t.pop*e(1e3)*5e-6),r=this.findPath(t,s);e(1e6)/(a(t.at,s.at)+.1)*(r?5:1)*t.pop*(s.pop>0?10:1)>5e5?(0==s.pop&&this.colonized++,t.log({arrived:n}),s.growCapped(n),s.log({grow:n})):(t.log({migrate:n}),t.growCapped(n)),t.updateColor()}}doRD(t,e){let s=100*e*this.rdSpeed(),i=s/this.rdFullCost(t);if(!(this.cash<s))return this.cash-=s,this.rdProgress[t]+=i,this.rdProgress[t]>=1&&(this.rd[t]++,this.rdProgress[t]=0,!0)}findPath(t,e){return h(t.id,e.id,t=>this.latency[t])}findDistances(t){return h(t.id,-1,t=>this.latency[t])}startResearch(t){this.rdActive[t]++}toggleResearch(t){this.rdActive[t]?this.rdActive[t]=0:this.rdActive[t]=1}linkPrice(){return 100*this.rd[C]}linkBandwith(t){return this.baseBandwith()+this.bandwithUpgrade()*(t.width-1)}payForLink(){this.entsUsed++,this.cash-=this.linkPrice()}removeLink(t){this.links.splice(this.links.indexOf(t),1),t.ends[0].removeLink(t.ends[1]),t.ends[1].removeLink(t.ends[0])}upgradeLink(t,e){1==e?(t.width++,this.payForLink()):(this.entsUsed--,t.width--,0==t.width&&this.removeLink(t)),this.recalculateLatency()}linkById(t){return this.stars[t%1e3].links[t/1e3|0]}togglePricing(t,e){let s=t.pricing;t.pricing==e?t.pricing=0:t.pricing=e,this.pricingUsed+=Math.abs(t.pricing)-Math.abs(s)}hasTagControls(){return!!(this.rd[F]||this.rd[Y]||this.rd[N]||this.rd[H])}investCost(t){return 5e4*(this.invested[t]+1)}canInvest(t){return this.cash>=this.investCost(t)&&this.rd[Y]>(this.invested[t]||0)}encourageTag(t){console.assert(t<36),this.encouragementsUsed++,this.encouraged[t]=P;let e=1+(0|this.tagsResearched[t])/2;for(let s of this.stars)s.has[t]+=50*e}tagResearchComplete(t){return this.tagsResearched[t]>=this.rd[N]}options(t,e){if(!this.rd[t])return 0;switch(t){case F:return!this.promoted[e]&&this.promotionsUsed>=this.rd[F]?0:this.promoted[e]?2:1;case Y:return this.canInvest(e)?1:0;case H:return this.encouragementsUsed<this.rd[H]&&!this.encouraged[e]?1:0}return 1}tagControl(t,e){switch(console.log(e,t),t){case F:this.promoted[e]?(this.promoted[e]=!1,this.promotionsUsed--):(this.promoted[e]=!0,this.promotionsUsed++);break;case Y:this.canInvest(e)&&(this.cash-=this.investCost(e),this.invested[e]++);break;case H:this.encourageTag(e)}}researchExpRequired(t){return t<1?0:500*Math.pow(2,t)}researchImpossible(t){return this.exp<this.researchExpRequired(t)?`Send ${this.researchExpRequired(t)} EB`:t!=N||this.tagsResearchUnlocked()?null:"Research topics"}tagsResearchUnlocked(){return!this.tagsResearched.some(t=>t<this.rd[N])}})}();
